<project name="martus-client-mac-dmg">
    <!-- version number -->
    <property name="version.full" value="3.5.1" />

    <!-- destination directory where mac app was written -->
    <property name="dist.mactree" value="/home/kevins/martus-mac/" />

    <!-- directory to copy dmg file to -->
    <property name="dmg.dest.dir" value="/home/kevins/" />

    <!-- parent directory containing JavaApplicationStub -->
    <property name="installer.mac" value="/home/kevins/work/miradi/hg/eclipse/miradi/build/installer/Mac/" />

    <!-- name of the main application jar (e.g. miradi.jar) -->
    <property name="app.jar" value="martus-client-20090826.1911.jar" />

    <!-- directory containing app.jar -->
    <property name="dist.dir" value="/home/kevins/work/martus/martus/0826-client/" />

    <!-- destination directory where mac app will be written -->
    <property name="dist.mactree" value="/home/kevins/martus-mac/" />

    <!-- directory containing third-party jars -->
    <property name="dist.temp.jars" value="/home/kevins/work/martus/martus/martus-thirdparty/" />

    <!-- name of the app as it will appear to Mac users -->
    <property name="mac.app.name" value="Martus" />

    <!-- short name of the app as it will appear to Mac users -->
    <property name="short.app.name" value="Martus" />

    <!-- version number -->
    <property name="version.full" value="3.5.1" />

    <!-- build identifier (typically a timestamp) -->
    <property name="version.timestamp" value="" />

    <!-- options to be passed to the JRE VM -->
    <property name="vm.options" value="-Xmx512m" />

    <target name="macappbundle" depends="" description="create a jar app bundle for the mac">
        <property name="macjavastubfile" value="${installer.mac}/JavaApplicationStub/JavaApplicationStub" />
        <taskdef name="jarbundler" 
            classname="net.sourceforge.jarbundler.JarBundler" 
            classpath="${installer.mac}/jarbundler-2.1.0/jarbundler-2.1.0.jar" />

        <mkdir dir="${dist.mactree}" />
        <delete>
            <fileset dir="${dist.mactree}" includes="*" />
        </delete>
        
        <jarbundler 
            dir="${dist.mactree}" 
            name="${mac.app.name}" 
            mainclass="org.miradi.main.Miradi" 
            jvmversion="1.5+" 
            stubfile="${macjavastubfile}" 
            shortname="${short.app.name}" 
            version="${version.full}"
            build="${version.timestamp}"
            vmoptions="${vm.options}"
            verbose="true"
            >

            <jarfileset dir="${dist.dir}">
                <include name="${app.jar}" />
            </jarfileset>
            <jarfileset dir="${dist.temp.jars}/">
                <include name="**/*.jar" />
                <exclude name="junit*" />
            </jarfileset>

            <javaproperty name="apple.laf.useScreenMenuBar" value="true" />
            <javaproperty name="apple.awt.brushMetal" value="true" />
            <javaproperty name="apple.awt.showGrowBox" value="true" />
            <javaproperty name="apple.awt.antialiasing" value="true" />
            <javaproperty name="apple.awt.textantialiasing" value="true" />
        </jarbundler>
    </target>

    <target name="macdmgfile" depends="macappbundle" description="create a mac dmg file">
        <property name="rawdmgfile" value="/home/kevins/Martus.dmg" />
        <property name="dmgsizemegs" value="1" />
        <property name="dmgmount" value="/mounts/Martus/dmgfile" />

        <exec os="Linux"  executable="umount" failonerror="false">
            <arg value="-d"/>
            <arg value="${dmgmount}"/>
        </exec>

        <!-- Create an empty .dmg file of the appropriate size -->
        <delete file="${rawdmgfile}" />	
        <exec os="Linux"  executable="dd" failonerror="true">
            <arg value="if=/dev/zero"/>
            <arg value="of=${rawdmgfile}"/>
            <arg value="bs=1M"/>
            <arg value="count=${dmgsizemegs}"/>
        </exec>
        
        <!-- Format that file as an hfsplus disk image -->
        <exec os="Linux"  executable="mkfs.hfsplus" failonerror="true">
            <arg value="-v"/>
            <arg value="Miradi ${version.full}"/>
            <arg value="${rawdmgfile}"/>
        </exec>
        
        <echo message="Mounting ${dmgmount} (must be in fstab)" />
        <echo message="  ${rawdmgfile} ${dmgmount} hfsplus rw,user,loop 0 0" />
        <exec os="Linux"  executable="mount" failonerror="true">
            <arg value="${dmgmount}"/>
        </exec>
        
        <!-- Copy .app directory to the disk image -->
        <!-- USING cp to PRESERVE FILE PERMISSIONS! -->
        <exec executable="cp">
            <arg value="-r" />
            <arg value="${dist.mactree}/${mac.app.name}.app" />
            <arg value="${dmgmount}" />
        </exec> 
    <!--    
        <copy todir="${dmgmount}">
            <fileset dir="${installer.buildfiles.dir}" includes="README.txt" />
            <fileset dir="${installer.buildfiles.dir}" includes="LICENSE.txt" />
            <fileset dir="${installer.buildfiles.dir}" includes="${samples.marine.mpz}" />
        </copy>
-->
        <exec os="Linux"  executable="umount" failonerror="true">
            <arg value="-d"/>
            <arg value="${dmgmount}"/>
        </exec>
        
        <copy todir="${dmg.dest.dir}" file="${rawdmgfile}" />

        <delete dir="${dist.mactree}" />
    </target>
</project>
