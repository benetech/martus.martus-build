<project name="martus" default="test-meta" basedir=".">

  <!-- set global properties for this build -->
  <property name="dist"  value="dist"/>
  <property name="docs"  value="TechDocs/javadocs"/>
  <property name="martus-dir" value="org/martus"/>
  <property name="martus-package" value="org.martus"/>
  
  <property name="common-dir" value="${martus-dir}/common"/>
  <property name="common-jar" value= "${dist}/martus-common.jar"/>
  <property name="common-package" value="${martus-package}.common"/>
  <property name="BuildDateFile" value="${common-dir}/BuildDate.txt"/>
  <property name="common-files" value="${common-dir}/*.class, ${BuildDateFile}"/>

  <property name="server-dir" value="${martus-dir}/server"/>
  <property name="server-jar" value= "${dist}/martus-server.jar"/>
  <property name="server-package" value="${martus-package}.server"/>
  <property name="server-files" value="${server-dir}/*.class,
  					${server-dir}/core/*.class,
  					${server-dir}/foramplifiers/*.class,
  					${server-dir}/forclients/*.class,
  					${server-dir}/formirroring/*.class,
  					${server-dir}/tools/*.class,
  					"/>

  <property name="client-dir" value="${martus-dir}/client"/>
  <property name="client-jar" value= "${dist}/martus.jar"/>
  <property name="client-package" value="${martus-package}.client"/>
  <property name="client-files" value="${client-dir}/*.class,
  			${client-dir}/test/*.class,
  			${client-dir}/core/*.class,
  			${client-dir}/core/main-class.txt,
  			${client-dir}/swingui/*.class,
    			${client-dir}/swingui/Martus-es.mtf,
    			${client-dir}/swingui/MartusHelp-en.txt,
    			${client-dir}/swingui/MartusHelp-es.txt,
    			${client-dir}/swingui/MartusHelpTOC-en.txt,
    			${client-dir}/swingui/MartusHelpTOC-es.txt,
    			${client-dir}/swingui/MartusLogo.gif,
    			${client-dir}/swingui/locked.jpg,
    			${client-dir}/swingui/unlocked.jpg,
    			${client-dir}/swingui/Martus.png"/>

  <property name="meta-dir" value="${martus-dir}/meta"/>
  <property name="meta-jar" value= "${dist}/martus-meta.jar"/>
  <property name="meta-package" value="${martus-package}.meta"/>
  <property name="meta-files" value="${meta-dir}/*.class"/>
  
  <target name="init">
    <!-- tstamp task initializes ${DSTAMP} etc -->
    <tstamp/>
  </target>

  <target name="clean">
  
    <!-- Remove dis jars & folder -->
    <delete verbose="true" includeEmptyDirs="true">
        <fileset dir="${dist}" includes="*.jar"/>
    </delete>
    <delete dir="${dist}"/>
    
    <delete file="${BuildDateFile}"/>
    
    <!-- Remove common class files -->
    <delete>
        <fileset dir="${common-dir}" includes="*.class"/>
    </delete>
    
    <!-- Remove meta class files -->
    <delete>
        <fileset dir="${meta-dir}" includes="*.class"/>
    </delete>
    
    <!-- Remove client class files -->
    <delete>
        <fileset dir="${client-dir}" includes="*.class"/>
        <fileset dir="${client-dir}/test/" includes="*.class"/>
        <fileset dir="${client-dir}/core/" includes="*.class"/>
        <fileset dir="${client-dir}/swingui/" includes="*.class"/>
    </delete>
    
    <!-- Remove server class files -->
    <delete>
        <fileset dir="${server-dir}" includes="*.class"/>
        <fileset dir="${server-dir}/core/" includes="*.class"/>
        <fileset dir="${server-dir}/foramplifiers/" includes="*.class"/>
        <fileset dir="${server-dir}/forclients/" includes="*.class"/>
        <fileset dir="${server-dir}/formirroring/" includes="*.class"/>
        <fileset dir="${server-dir}/tools/" includes="*.class"/>
    </delete>
  </target>

  <target name="build" depends="init">

    <echo message="${DSTAMP}" file="${BuildDateFile}"/>
    <javac srcdir="${common-dir}" failonerror="true"/>

    <javac srcdir="${server-dir}" classpath="${common-dir}" failonerror="true"/>
    <javac srcdir="${server-dir}/core" classpath="${common-dir}" failonerror="true"/>
    <javac srcdir="${server-dir}/foramplifiers" classpath="${common-dir}" failonerror="true"/>
    <javac srcdir="${server-dir}/forclients" classpath="${common-dir}" failonerror="true"/>
    <javac srcdir="${server-dir}/formirroring" classpath="${common-dir}" failonerror="true"/>
    <javac srcdir="${server-dir}/tools" classpath="${common-dir}" failonerror="true"/>

    <javac srcdir="${client-dir}" classpath="${common-dir}" failonerror="true"/>
    <javac srcdir="${client-dir}/core" classpath="${common-dir}" failonerror="true"/>
    <javac srcdir="${client-dir}/swingui" classpath="${common-dir}" failonerror="true"/>
    <javac srcdir="${client-dir}/test" classpath="${common-dir}" failonerror="true"/>

    <javac srcdir="${meta-dir}" classpath="${common-dir};${client-dir};${server-dir}" failonerror="true"/>

    <mkdir dir="${dist}"/>
    <jar jarfile="${common-jar}" basedir="." 
    		includes="${common-files}"/>
    <jar jarfile="${server-jar}" basedir="." 
    		includes="${server-files}, 
    				${server-files}/core,
    				${server-files}/foramplifiers,
    				${server-files}/forclients,
    				${server-files}/formirroring,
    				${server-files}/tools,
    				${common-files}"/>
    <jar jarfile="${client-jar}" basedir="." 
			manifest="${client-dir}/core/main-class.txt" 
    		includes="${client-files}/core,
    				${client-files}/swingui,
    				${client-files}/test,
    				${common-files}"/>
    <jar jarfile="${meta-jar}" basedir="." 
    		includes="${meta-files}, 
    				${common-files}, 
    				${server-files},
    				${client-files}"/>

  </target>

  <target name="test-common" depends="build">
	<!-- Run the unit test suite -->
	<java classname="${common-package}.TestAll" 
		fork="true"
		classpath = "${common-jar}"/>
  </target>

  <target name="test-server" depends="build">
	<!-- Run the unit test suite -->
	<java classname="${server-package}.TestAll" 
		fork="true"
		classpath = "${server-jar}"/>
  </target>

  <target name="test-client" depends="build">
	<!-- Run the unit test suite -->
	<java classname="${client-package}.TestAll" 
		fork="true"
		classpath = "${client-jar}"/>
  </target>

  <target name="test-meta" depends="build">
	<!-- Run the unit test suite -->
	<java classname="${meta-package}.TestAll" 
		fork="true"
		classpath = "${meta-jar}"/>
  </target>
  
	<target name="docs">
		<!-- Generate javadocs  -->
			<javadoc destdir="${docs}" access="private" use="true">
				
				<!-- Generate Server javadocs  -->
        <fileset dir="${server-dir}" includes="*.java"/>
        <fileset dir="${server-dir}/core/" includes="*.java"/>
        <fileset dir="${server-dir}/foramplifiers/" includes="*.java"/>
        <fileset dir="${server-dir}/forclients/" includes="*.java"/>
        <fileset dir="${server-dir}/formirroring/" includes="*.java"/>
        <fileset dir="${server-dir}/tools/" includes="*.java"/>
        
        <!-- Generate Client javadocs  -->
        <fileset dir="${client-dir}" includes="*.java"/>
        <fileset dir="${client-dir}/test/" includes="*.java"/>
        <fileset dir="${client-dir}/core/" includes="*.java"/>
        <fileset dir="${client-dir}/swingui/" includes="*.java"/>
        
        <!-- Generate the rest of javadocs  -->
        <fileset dir="${common-dir}" includes="*.java"/>
        <fileset dir="${meta-dir}" includes="*.java"/>
			</javadoc>
	</target>

</project>

